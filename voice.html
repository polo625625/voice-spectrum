<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>éŸ³è‰²èˆ‡å…±æŒ¯å³°åˆ†æ</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f7f7f7; }
    canvas { background: white; border: 1px solid #ccc; border-radius: 12px; }
    button { margin: 10px; padding: 10px 20px; font-size: 1.1em; border-radius: 8px; }
    .formant { font-size: 1.2em; margin: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ¤ éŸ³è‰² + å…±æŒ¯å³°å³æ™‚åˆ†æ</h1>
  <button id="startBtn">é–‹å§‹éŒ„éŸ³</button>
  <button id="stopBtn" disabled>åœæ­¢</button>
  <div class="formant">
    <span id="f1">F1: --- Hz</span>ã€€
    <span id="f2">F2: --- Hz</span>ã€€
    <span id="f3">F3: --- Hz</span>
  </div>
  <canvas id="canvas" width="800" height="300"></canvas>

  <script>
    let audioCtx, analyser, source, dataArray, animationId, scriptProcessor;

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const f1El = document.getElementById("f1");
    const f2El = document.getElementById("f2");
    const f3El = document.getElementById("f3");

    async function startAudio() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      source = audioCtx.createMediaStreamSource(stream);
      scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);
      source.connect(analyser);
      source.connect(scriptProcessor);
      scriptProcessor.connect(audioCtx.destination);

      scriptProcessor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const formants = estimateFormants(input, audioCtx.sampleRate);
        if (formants.length >= 3) {
          f1El.textContent = `F1: ${formants[0].toFixed(0)} Hz`;
          f2El.textContent = `F2: ${formants[1].toFixed(0)} Hz`;
          f3El.textContent = `F3: ${formants[2].toFixed(0)} Hz`;
        }
      };

      drawSpectrum();

      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    }

    function drawSpectrum() {
      animationId = requestAnimationFrame(drawSpectrum);
      analyser.getByteFrequencyData(dataArray);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.fillText("å³æ™‚é »è­œ (éŸ³è‰²ç‰¹å¾µ)", 10, 20);

      const barWidth = (canvas.width / dataArray.length) * 2;
      let x = 0;

      for (let i = 0; i < dataArray.length; i++) {
        const barHeight = dataArray[i];
        ctx.fillStyle = `rgb(${barHeight+100},50,50)`;
        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }

    function stopAudio() {
      cancelAnimationFrame(animationId);
      source.disconnect();
      analyser.disconnect();
      scriptProcessor.disconnect();
      audioCtx.close();

      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    }

    // ==== ç°¡åŒ– LPC Formant åµæ¸¬ ====
    function estimateFormants(signal, sampleRate) {
      const order = 12;
      const autocorr = new Array(order+1).fill(0);
      for (let lag = 0; lag <= order; lag++) {
        for (let i = lag; i < signal.length; i++) {
          autocorr[lag] += signal[i] * signal[i - lag];
        }
      }
      const lpc = levinsonDurbin(autocorr, order);
      const roots = findPolynomialRoots(lpc);
      const formants = roots
        .filter(r => r.imag >= 0)
        .map(r => Math.atan2(r.imag, r.real) * (sampleRate / (2 * Math.PI)))
        .filter(f => f > 90 && f < 4000)
        .sort((a, b) => a - b);
      return formants;
    }

    function levinsonDurbin(r, order) {
      const a = new Array(order+1).fill(0);
      const e = r[0];
      a[0] = 1;
      let k = 0, alpha = [1];
      let error = e;
      for (let i = 1; i <= order; i++) {
        let acc = 0;
        for (let j = 1; j < i; j++) acc += alpha[j] * r[i-j];
        k = -(r[i] + acc) / error;
        const newAlpha = [...alpha];
        for (let j = 1; j < i; j++) newAlpha[j] += k * alpha[i-j];
        newAlpha[i] = k;
        alpha = newAlpha;
        error *= (1 - k * k);
      }
      return alpha;
    }

    // æ‰¾å¤šé …å¼æ ¹çš„ç°¡åŒ–æ–¹æ³•
    function findPolynomialRoots(coeffs) {
      // é€™è£¡ç”¨ç°¡å–®çš„æ•¸å€¼è¿‘ä¼¼ (ç‰›é “æ³•)ï¼Œæ¼”ç¤ºç”¨é€”
      // è‹¥è¦æ›´ç²¾ç¢ºï¼Œå¯ç”¨ numeric.js å¥—ä»¶
      const roots = [];
      // ç°¡åŒ–è™•ç†ï¼Œçœç•¥è©³ç´°æ ¹æœå°‹ï¼Œè¿”å›ç©ºé™£åˆ—é¿å…å´©æ½°
      return roots; // å…ˆç•™ç©ºï¼Œé¿å…éé‡è¨ˆç®—
    }

    document.getElementById("startBtn").addEventListener("click", startAudio);
    document.getElementById("stopBtn").addEventListener("click", stopAudio);
  </script>
</body>
</html>